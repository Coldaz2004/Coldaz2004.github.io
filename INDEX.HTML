<!-- Lista de Facturas --><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FACTURAS - Sistema de Facturaci√≥n Electr√≥nica</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1200px;
            margin: 20px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            padding: 40px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .navigation {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: none;
        }

        .navigation.active {
            display: block;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e1e5e9;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .invoice-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .invoice-items {
            margin-top: 30px;
        }

        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .invoice-total {
            text-align: right;
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: rgba(102, 126, 234, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .invoice-list {
            margin-top: 30px;
        }

        .invoice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status.enviado {
            background: #d4edda;
            color: #155724;
        }

        .status.pendiente {
            background: #fff3cd;
            color: #856404;
        }

        .status.rechazado {
            background: #f8d7da;
            color: #721c24;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid transparent;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        @media (max-width: 768px) {
            .invoice-form {
                grid-template-columns: 1fr;
            }
            
            .item-row {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .invoice-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">‚ö° FACTURAS</div>
            <div class="subtitle">Sistema de Facturaci√≥n Electr√≥nica - DESARROLLO DE SOFTWARE SAS</div>
        </div>

        <div class="navigation" id="navigation">
            <div class="nav-buttons">
                <button class="btn btn-primary" onclick="showScreen('dashboard')">üè† Inicio</button>
                <button class="btn btn-secondary" onclick="showScreen('create-invoice')">üìù Crear Factura</button>
                <button class="btn btn-secondary" onclick="showScreen('upload-invoice')">üì§ Subir Factura</button>
                <button class="btn btn-secondary" onclick="showScreen('invoice-list')">üìã Lista de Facturas</button>
                <button class="btn btn-danger" onclick="logout()" style="margin-left: auto;">üö™ Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div class="main-content">
            <!-- Pantalla de Login -->
            <div id="login-screen" class="screen active">
                <div style="max-width: 400px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">Iniciar Sesi√≥n</h2>
                    
                    <!-- Mensaje de error para login -->
                    <div id="login-error" class="alert alert-danger" style="display: none;">
                        <strong>‚ùå Usuario o contrase√±a incorrectos</strong><br>
                        Intente nuevamente
                    </div>
                    
                    <div>
                        <div class="form-group">
                            <label for="username">Usuario:</label>
                            <input type="text" id="username" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="password">Contrase√±a:</label>
                            <input type="password" id="password" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" onclick="handleLogin()" style="width: 100%;">Ingresar</button>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <a href="#" onclick="showScreen('register')" style="color: #667eea; text-decoration: none;">¬øNo tienes cuenta? Reg√≠strate aqu√≠</a><br>
                        <a href="#" onclick="showScreen('reset-password')" style="color: #dc3545; text-decoration: none; font-size: 0.9rem; margin-top: 10px; display: inline-block;">¬øOlvidaste tu contrase√±a?</a>
                    </div>
                </div>
            </div>

            <!-- Pantalla de Registro -->
            <div id="register-screen" class="screen">
                <div style="max-width: 500px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">Registrar Nueva Cuenta</h2>
                    
                    <!-- Mensaje de √©xito para registro -->
                    <div id="register-success" class="alert alert-success" style="display: none;">
                        <strong>‚úÖ Usuario ha sido registrado exitosamente</strong><br>
                        Ya puedes iniciar sesi√≥n con tus credenciales
                    </div>
                    
                    <!-- Mensaje de error para registro -->
                    <div id="register-error" class="alert alert-danger" style="display: none;">
                        <strong>‚ùå Error en el registro</strong><br>
                        <span id="register-error-message"></span>
                    </div>
                    
                    <div>
                        <div class="form-group">
                            <label for="reg-company">Empresa:</label>
                            <input type="text" id="reg-company" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="reg-nit">NIT:</label>
                            <input type="text" id="reg-nit" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="reg-username">Usuario:</label>
                            <input type="text" id="reg-username" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="reg-email">Email:</label>
                            <input type="email" id="reg-email" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="reg-password">Contrase√±a:</label>
                            <input type="password" id="reg-password" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" onclick="handleRegister()" style="width: 100%;">Registrarse</button>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <a href="#" onclick="showScreen('login')" style="color: #667eea; text-decoration: none;">¬øYa tienes cuenta? Inicia sesi√≥n</a><br>
                        <a href="#" onclick="showScreen('reset-password')" style="color: #dc3545; text-decoration: none; font-size: 0.9rem; margin-top: 10px; display: inline-block;">¬øOlvidaste tu contrase√±a?</a>
                    </div>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboard-screen" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <div>
                        <h1 id="company-name-header" style="color: #2c3e50; margin: 0; font-size: 2rem; font-weight: bold;"></h1>
                        <h3 style="color: #667eea; margin: 5px 0 0 0;">Panel de Control</h3>
                    </div>
                    <div style="text-align: right; color: #666;">
                        <p style="margin: 0;"><strong>Usuario:</strong> <span id="current-user-name"></span></p>
                        <p style="margin: 0; font-size: 0.9rem;" id="current-date"></p>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-title">üìä Resumen General</div>
                        <p><strong>Facturas Creadas:</strong> <span id="total-facturas">0</span></p>
                        <p><strong>Enviadas a DIAN:</strong> <span id="enviadas-dian">0</span></p>
                        <p><strong>Pendientes:</strong> <span id="pendientes">0</span></p>
                        <p><strong>Total Facturado:</strong> $<span id="total-facturado">0</span></p>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">‚ö° Acciones R√°pidas</div>
                        <button class="btn btn-primary" onclick="showScreen('create-invoice')" style="width: 100%; margin-bottom: 10px;">Crear Nueva Factura</button>
                        <button class="btn btn-secondary" onclick="showScreen('upload-invoice')" style="width: 100%; margin-bottom: 10px;">Subir Factura</button>
                        <button class="btn btn-success" onclick="sendAllToDian()" style="width: 100%;">Enviar Todo a DIAN</button>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">üìà Estado DIAN</div>
                        <div class="alert alert-success">
                            <strong>‚úì Conexi√≥n Activa</strong><br>
                            Sistema conectado correctamente con la DIAN
                        </div>
                        <button class="btn btn-warning" onclick="testDianConnection()" style="width: 100%;">Probar Conexi√≥n</button>
                    </div>
                </div>
            </div>

            <!-- Crear Factura -->
            <div id="create-invoice-screen" class="screen">
                <h2 style="color: #2c3e50; margin-bottom: 30px;">Crear Nueva Factura</h2>
                
                <form onsubmit="createInvoice(event)">
                    <div class="invoice-form">
                        <div class="form-group">
                            <label for="invoice-number">N√∫mero de Factura:</label>
                            <input type="text" id="invoice-number" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="invoice-date">Fecha:</label>
                            <input type="date" id="invoice-date" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="client-name">Nombre del Cliente:</label>
                            <input type="text" id="client-name" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="client-nit">NIT/CC Cliente:</label>
                            <input type="text" id="client-nit" class="form-control" required>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="client-address">Direcci√≥n del Cliente:</label>
                            <input type="text" id="client-address" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="invoice-items">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Productos/Servicios</h3>
                        <div id="items-container">
                            <div class="item-row">
                                <input type="text" placeholder="Descripci√≥n" class="form-control item-description" required>
                                <input type="number" placeholder="Cantidad" class="form-control item-quantity" min="1" required>
                                <input type="number" placeholder="Valor Unitario" class="form-control item-price" step="0.01" required>
                                <input type="number" placeholder="Total" class="form-control item-total" readonly>
                                <button type="button" class="btn btn-danger" onclick="removeItem(this)">üóëÔ∏è</button>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-secondary" onclick="addItem()">‚ûï Agregar Producto</button>
                        
                        <div class="invoice-total">
                            <div>Subtotal: $<span id="subtotal">0.00</span></div>
                            <div>IVA (19%): $<span id="iva">0.00</span></div>
                            <div style="font-size: 1.5rem; color: #28a745;">Total: $<span id="total">0.00</span></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button type="submit" class="btn btn-success" style="margin-right: 15px;">üíæ Crear Factura</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">üîÑ Limpiar</button>
                    </div>
                </form>
            </div>

            <!-- Subir Factura -->
            <div id="upload-invoice-screen" class="screen">
                <h2 style="color: #2c3e50; margin-bottom: 30px;">Subir Factura Existente</h2>
                
                <div class="file-upload" onclick="document.getElementById('file-input').click()">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üìÑ</div>
                    <h3>Haz clic para seleccionar archivo</h3>
                    <p>Formatos soportados: PDF, XML, TXT</p>
                    <input type="file" id="file-input" style="display: none;" accept=".pdf,.xml,.txt" onchange="handleFileUpload(event)">
                </div>
                
                <div id="upload-result" style="margin-top: 30px;"></div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn btn-primary" onclick="processUploadedFile()">üì§ Procesar y Enviar a DIAN</button>
                </div>
            </div>

            <!-- Pantalla de Restablecimiento de Contrase√±a -->
            <div id="reset-password-screen" class="screen">
                <div style="max-width: 450px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">Restablecer Contrase√±a</h2>
                    
                    <!-- Paso 1: Solicitar email -->
                    <div id="reset-step1" style="display: block;">
                        <div class="alert alert-warning">
                            <strong>üîê Recuperaci√≥n de Contrase√±a</strong><br>
                            Ingresa tu email registrado y te enviaremos un c√≥digo de verificaci√≥n.
                        </div>
                        
                        <!-- Mensaje de error para reset -->
                        <div id="reset-error" class="alert alert-danger" style="display: none;">
                            <strong>‚ùå Error</strong><br>
                            <span id="reset-error-message"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="reset-email">Email registrado:</label>
                            <input type="email" id="reset-email" class="form-control" required placeholder="ejemplo@correo.com">
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" onclick="sendResetCode()" style="width: 100%;">üìß Enviar C√≥digo</button>
                        </div>
                    </div>
                    
                    <!-- Paso 2: Verificar c√≥digo -->
                    <div id="reset-step2" style="display: none;">
                        <div class="alert alert-success">
                            <strong>‚úÖ C√≥digo Enviado</strong><br>
                            Hemos enviado un c√≥digo de 6 d√≠gitos a tu email: <span id="email-sent"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="reset-code">C√≥digo de verificaci√≥n:</label>
                            <input type="text" id="reset-code" class="form-control" required placeholder="123456" maxlength="6" style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem;">
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn btn-success" onclick="verifyResetCode()" style="width: 100%;">‚úì Verificar C√≥digo</button>
                        </div>
                        
                        <div style="text-align: center; margin-top: 15px;">
                            <a href="#" onclick="sendResetCode()" style="color: #667eea; text-decoration: none; font-size: 0.9rem;">Reenviar c√≥digo</a>
                        </div>
                    </div>
                    
                    <!-- Paso 3: Nueva contrase√±a -->
                    <div id="reset-step3" style="display: none;">
                        <div class="alert alert-success">
                            <strong>üîì C√≥digo Verificado</strong><br>
                            Ahora puedes establecer una nueva contrase√±a.
                        </div>
                        
                        <div class="form-group">
                            <label for="new-password">Nueva contrase√±a:</label>
                            <input type="password" id="new-password" class="form-control" required placeholder="M√≠nimo 6 caracteres">
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm-password">Confirmar contrase√±a:</label>
                            <input type="password" id="confirm-password" class="form-control" required placeholder="Repetir contrase√±a">
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn btn-success" onclick="resetPassword()" style="width: 100%;">üîÑ Cambiar Contrase√±a</button>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <a href="#" onclick="showScreen('login')" style="color: #667eea; text-decoration: none;">‚Üê Volver al inicio de sesi√≥n</a>
                    </div>
                </div>
            </div>
            <div id="invoice-list-screen" class="screen">
                <h2 style="color: #2c3e50; margin-bottom: 30px;">Lista de Facturas</h2>
                
                <div style="margin-bottom: 20px;">
                    <input type="text" id="search-invoice" class="form-control" placeholder="üîç Buscar factura..." onkeyup="filterInvoices()" style="max-width: 400px;">
                </div>
                
                <div class="invoice-list" id="invoice-list">
                    <!-- Las facturas se cargar√°n aqu√≠ din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let invoices = [];
        let users = [];

        // Variables para reset de contrase√±a
        let resetData = {
            email: null,
            code: null,
            generatedCode: null,
            userId: null
        };

        // Base de datos de usuarios en memoria
        let userDatabase = [];
        
        // Cargar datos del almacenamiento en memoria (sin localStorage)
        function loadData() {
            // Los datos se mantienen en memoria durante la sesi√≥n
            if (users.length === 0) {
                // Crear usuario administrador por defecto
                const adminUser = {
                    id: 1,
                    company: 'DESARROLLO DE SOFTWARE SAS',
                    nit: '901234567-8',
                    username: 'admin',
                    email: 'admin@desarrollosoftware.com',
                    password: 'admin123',
                    createdAt: new Date().toISOString(),
                    role: 'admin'
                };
                
                users.push(adminUser);
                userDatabase.push(adminUser);
            }
        }

        // Guardar usuario en la base de datos
        function saveUserToDatabase(user) {
            userDatabase.push(user);
            users.push(user);
            console.log('Usuario guardado en la base de datos:', user.username);
            console.log('Total usuarios en la base de datos:', userDatabase.length);
        }

        // Obtener todos los usuarios de la base de datos
        function getAllUsers() {
            return userDatabase;
        }

        // Buscar usuario por username
        function findUserByUsername(username) {
            return userDatabase.find(user => user.username === username);
        }

        // Autenticar usuario
        function authenticateUser(username, password) {
            return userDatabase.find(user => 
                user.username === username && user.password === password
            );
        }

        // Guardar datos en memoria (simulaci√≥n de base de datos)
        function saveData() {
            // Los datos se mantienen en las variables globales
            console.log('Datos guardados en memoria');
        }

        // Mostrar pantalla
        function showScreen(screenName) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => screen.classList.remove('active'));
            
            const targetScreen = document.getElementById(screenName + '-screen');
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
            
            // Ocultar mensajes al cambiar de pantalla
            if (screenName === 'login') {
                hideLoginError();
            } else if (screenName === 'register') {
                hideRegisterMessages();
            } else if (screenName === 'reset-password') {
                hideResetError();
                // Resetear pasos del restablecimiento
                document.getElementById('reset-step1').style.display = 'block';
                document.getElementById('reset-step2').style.display = 'none';
                document.getElementById('reset-step3').style.display = 'none';
                // Limpiar campos
                document.getElementById('reset-email').value = '';
                document.getElementById('reset-code').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            }
            
            // Mostrar/ocultar navegaci√≥n
            const navigation = document.getElementById('navigation');
            if (screenName === 'login' || screenName === 'register') {
                navigation.classList.remove('active');
            } else {
                navigation.classList.add('active');
            }
            
            // Actualizar dashboard si es necesario
            if (screenName === 'dashboard') {
                updateDashboard();
            } else if (screenName === 'invoice-list') {
                loadInvoiceList();
            }
        }

        // Funciones para mostrar/ocultar mensajes
        function showLoginError() {
            const errorDiv = document.getElementById('login-error');
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function hideLoginError() {
            const errorDiv = document.getElementById('login-error');
            errorDiv.style.display = 'none';
        }

        function showRegisterSuccess() {
            const successDiv = document.getElementById('register-success');
            successDiv.style.display = 'block';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 10000); // 10 segundos para mensaje de √©xito
        }

        function showRegisterError(message) {
            const errorDiv = document.getElementById('register-error');
            const messageSpan = document.getElementById('register-error-message');
            messageSpan.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function hideRegisterMessages() {
            document.getElementById('register-success').style.display = 'none';
            document.getElementById('register-error').style.display = 'none';
        }

        function showResetError(message) {
            const errorDiv = document.getElementById('reset-error');
            const messageSpan = document.getElementById('reset-error-message');
            messageSpan.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function hideResetError() {
            document.getElementById('reset-error').style.display = 'none';
        }

        // Funciones simplificadas para manejar login y registro
        function handleLogin() {
            console.log('Bot√≥n de login presionado');
            
            // Ocultar mensaje de error previo
            hideLoginError();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            console.log('Intentando autenticar usuario:', username);
            console.log('Total usuarios en base de datos:', userDatabase.length);
            
            if (!username || !password) {
                showLoginError();
                return;
            }
            
            // Usar la funci√≥n de autenticaci√≥n de la base de datos
            const user = authenticateUser(username, password);
            
            if (user) {
                currentUser = user;
                console.log('Login exitoso para:', user.company);
                hideLoginError();
                
                // Limpiar campos
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                alert('¬°Bienvenido a ' + user.company + '!');
                showScreen('dashboard');
                generateInvoiceNumber();
            } else {
                console.log('Login fallido para usuario:', username);
                showLoginError();
                
                // Limpiar solo la contrase√±a por seguridad
                document.getElementById('password').value = '';
                
                // Enfocar el campo de usuario para facilitar el reintento
                document.getElementById('username').focus();
            }
        }

        function handleRegister() {
            console.log('Bot√≥n de registro presionado');
            
            // Ocultar mensajes previos
            hideRegisterMessages();
            
            const company = document.getElementById('reg-company').value.trim();
            const nit = document.getElementById('reg-nit').value.trim();
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value.trim();
            
            // Validar campos
            if (!company || !nit || !username || !email || !password) {
                showRegisterError('Por favor completa todos los campos');
                return;
            }
            
            // Validar longitud m√≠nima de contrase√±a
            if (password.length < 6) {
                showRegisterError('La contrase√±a debe tener al menos 6 caracteres');
                return;
            }
            
            // Verificar si el usuario ya existe
            if (findUserByUsername(username)) {
                showRegisterError('El nombre de usuario ya existe. Elige otro.');
                return;
            }
            
            // Verificar si el email ya existe
            if (userDatabase.find(u => u.email === email)) {
                showRegisterError('El email ya est√° registrado. Usa otro email.');
                return;
            }
            
            // Crear nuevo usuario
            const newUser = {
                id: Date.now(),
                company,
                nit,
                username,
                email,
                password,
                createdAt: new Date().toISOString(),
                role: 'user'
            };
            
            // Guardar en la base de datos
            saveUserToDatabase(newUser);
            
            console.log('Usuario registrado exitosamente:', newUser.username);
            console.log('Datos del nuevo usuario:', {
                empresa: newUser.company,
                nit: newUser.nit,
                usuario: newUser.username,
                email: newUser.email
            });
            
            // Mostrar mensaje de √©xito
            showRegisterSuccess();
            
            // Limpiar formulario
            document.getElementById('reg-company').value = '';
            document.getElementById('reg-nit').value = '';
            document.getElementById('reg-username').value = '';
            document.getElementById('reg-email').value = '';
            document.getElementById('reg-password').value = '';
            
            // Opcional: cambiar a pantalla de login despu√©s de 3 segundos
            setTimeout(() => {
                showScreen('login');
                // Pre-llenar el usuario en el login
                document.getElementById('username').value = newUser.username;
            }, 3000);
        }

        // ========== FUNCIONES DE RESTABLECIMIENTO DE CONTRASE√ëA ==========
        
        function sendResetCode() {
            console.log('Enviando c√≥digo de restablecimiento...');
            hideResetError();
            
            const email = document.getElementById('reset-email').value.trim();
            
            if (!email) {
                showResetError('Por favor ingresa tu email');
                return;
            }
            
            // Buscar usuario por email
            const user = userDatabase.find(u => u.email === email);
            
            if (!user) {
                showResetError('No existe una cuenta registrada con este email');
                return;
            }
            
            // Generar c√≥digo de 6 d√≠gitos
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            
            // Guardar datos del reset
            resetData = {
                email: email,
                generatedCode: code,
                userId: user.id
            };
            
            console.log('C√≥digo generado para', email, ':', code);
            
            // Simular env√≠o de email
            simulateEmailSend(email, code, user.company);
            
            // Mostrar el email en la pantalla
            document.getElementById('email-sent').textContent = email;
            
            // Cambiar a paso 2
            document.getElementById('reset-step1').style.display = 'none';
            document.getElementById('reset-step2').style.display = 'block';
            
            showNotification(`üìß C√≥digo enviado a ${email}`, 'success');
        }

        function simulateEmailSend(email, code, company) {
            // Esta funci√≥n simula el env√≠o del email
            // En un sistema real, aqu√≠ se har√≠a la llamada al servidor de email
            
            const emailContent = `
                ======================================
                üîê C√ìDIGO DE RESTABLECIMIENTO
                ======================================
                
                Empresa: ${company}
                Email: ${email}
                
                Tu c√≥digo de verificaci√≥n es: ${code}
                
                Este c√≥digo expira en 10 minutos.
                
                Si no solicitaste este cambio, ignora este mensaje.
                
                ======================================
                Sistema FACTURAS
                DESARROLLO DE SOFTWARE SAS
                ======================================
            `;
            
            console.log('EMAIL SIMULADO ENVIADO:');
            console.log(emailContent);
            
            // En desarrollo, tambi√©n podr√≠amos mostrar el c√≥digo en una alerta
            // alert('C√ìDIGO DE PRUEBA: ' + code + '\n(En producci√≥n se enviar√≠a por email)');
        }

        function verifyResetCode() {
            console.log('Verificando c√≥digo...');
            hideResetError();
            
            const enteredCode = document.getElementById('reset-code').value.trim();
            
            if (!enteredCode) {
                showResetError('Por favor ingresa el c√≥digo');
                return;
            }
            
            if (enteredCode !== resetData.generatedCode) {
                showResetError('C√≥digo incorrecto. Verifica e intenta nuevamente.');
                // Limpiar campo
                document.getElementById('reset-code').value = '';
                return;
            }
            
            console.log('C√≥digo verificado correctamente');
            
            // Cambiar a paso 3
            document.getElementById('reset-step2').style.display = 'none';
            document.getElementById('reset-step3').style.display = 'block';
            
            showNotification('‚úÖ C√≥digo verificado correctamente', 'success');
        }

        function resetPassword() {
            console.log('Restableciendo contrase√±a...');
            hideResetError();
            
            const newPassword = document.getElementById('new-password').value.trim();
            const confirmPassword = document.getElementById('confirm-password').value.trim();
            
            if (!newPassword || !confirmPassword) {
                showResetError('Por favor completa ambos campos');
                return;
            }
            
            if (newPassword.length < 6) {
                showResetError('La contrase√±a debe tener al menos 6 caracteres');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showResetError('Las contrase√±as no coinciden');
                return;
            }
            
            // Encontrar y actualizar la contrase√±a del usuario
            const userIndex = userDatabase.findIndex(u => u.id === resetData.userId);
            if (userIndex !== -1) {
                userDatabase[userIndex].password = newPassword;
                
                // Tambi√©n actualizar en el array users
                const usersIndex = users.findIndex(u => u.id === resetData.userId);
                if (usersIndex !== -1) {
                    users[usersIndex].password = newPassword;
                }
                
                console.log('Contrase√±a actualizada para usuario:', userDatabase[userIndex].username);
                
                // Limpiar datos del reset
                resetData = {
                    email: null,
                    code: null,
                    generatedCode: null,
                    userId: null
                };
                
                // Limpiar formularios
                document.getElementById('reset-email').value = '';
                document.getElementById('reset-code').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
                
                // Resetear pasos
                document.getElementById('reset-step1').style.display = 'block';
                document.getElementById('reset-step2').style.display = 'none';
                document.getElementById('reset-step3').style.display = 'none';
                
                showNotification('üîÑ Contrase√±a cambiada exitosamente', 'success');
                
                alert('‚úÖ ¬°Contrase√±a restablecida exitosamente!\n\nYa puedes iniciar sesi√≥n con tu nueva contrase√±a.');
                
                // Ir a login
                showScreen('login');
            } else {
                showResetError('Error interno. Por favor intenta nuevamente.');
            }
        }

        // Cerrar sesi√≥n
        function logout() {
            currentUser = null;
            showScreen('login');
            // Limpiar formularios
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Generar n√∫mero de factura autom√°tico
        function generateInvoiceNumber() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const userInvoices = invoices.filter(inv => inv.userId === currentUser.id).length;
            const invoiceNumber = `${year}${month}${String(userInvoices + 1).padStart(4, '0')}`;
            document.getElementById('invoice-number').value = invoiceNumber;
            document.getElementById('invoice-date').value = today.toISOString().split('T')[0];
        }

        // Agregar producto a la factura
        function addItem() {
            const container = document.getElementById('items-container');
            const newRow = document.createElement('div');
            newRow.className = 'item-row';
            newRow.innerHTML = `
                <input type="text" placeholder="Descripci√≥n" class="form-control item-description" required>
                <input type="number" placeholder="Cantidad" class="form-control item-quantity" min="1" required>
                <input type="number" placeholder="Valor Unitario" class="form-control item-price" step="0.01" required>
                <input type="number" placeholder="Total" class="form-control item-total" readonly>
                <button type="button" class="btn btn-danger" onclick="removeItem(this)">üóëÔ∏è</button>
            `;
            container.appendChild(newRow);
            attachItemListeners(newRow);
        }

        // Remover producto
        function removeItem(button) {
            button.closest('.item-row').remove();
            calculateTotals();
        }

        // Calcular totales
        function calculateTotals() {
            let subtotal = 0;
            const itemRows = document.querySelectorAll('.item-row');
            
            itemRows.forEach(row => {
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const total = quantity * price;
                
                row.querySelector('.item-total').value = total.toFixed(2);
                subtotal += total;
            });
            
            const iva = subtotal * 0.19;
            const total = subtotal + iva;
            
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('iva').textContent = iva.toFixed(2);
            document.getElementById('total').textContent = total.toFixed(2);
        }

        // Adjuntar listeners a los campos de productos
        function attachItemListeners(row) {
            const quantityInput = row.querySelector('.item-quantity');
            const priceInput = row.querySelector('.item-price');
            
            quantityInput.addEventListener('input', calculateTotals);
            priceInput.addEventListener('input', calculateTotals);
        }

        // Crear factura
        function createInvoice(event) {
            event.preventDefault();
            
            const invoiceData = {
                id: Date.now(),
                userId: currentUser.id,
                number: document.getElementById('invoice-number').value,
                date: document.getElementById('invoice-date').value,
                clientName: document.getElementById('client-name').value,
                clientNit: document.getElementById('client-nit').value,
                clientAddress: document.getElementById('client-address').value,
                items: [],
                subtotal: parseFloat(document.getElementById('subtotal').textContent),
                iva: parseFloat(document.getElementById('iva').textContent),
                total: parseFloat(document.getElementById('total').textContent),
                status: 'pendiente',
                createdAt: new Date().toISOString()
            };
            
            // Recopilar productos
            const itemRows = document.querySelectorAll('.item-row');
            itemRows.forEach(row => {
                const item = {
                    description: row.querySelector('.item-description').value,
                    quantity: parseFloat(row.querySelector('.item-quantity').value),
                    price: parseFloat(row.querySelector('.item-price').value),
                    total: parseFloat(row.querySelector('.item-total').value)
                };
                invoiceData.items.push(item);
            });
            
            invoices.push(invoiceData);
            saveData();
            
            alert('Factura creada exitosamente');
            clearForm();
            generateInvoiceNumber();
            
            // Simular env√≠o a DIAN
            setTimeout(() => {
                simulateDianSubmission(invoiceData.id);
            }, 2000);
        }

        // Limpiar formulario
        function clearForm() {
            document.getElementById('client-name').value = '';
            document.getElementById('client-nit').value = '';
            document.getElementById('client-address').value = '';
            
            // Limpiar productos excepto el primero
            const container = document.getElementById('items-container');
            const firstRow = container.querySelector('.item-row');
            container.innerHTML = '';
            container.appendChild(firstRow);
            
            // Limpiar primera fila
            firstRow.querySelectorAll('input').forEach(input => {
                if (!input.readOnly) input.value = '';
            });
            
            calculateTotals();
        }

        // Manejar subida de archivos
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const result = document.getElementById('upload-result');
                result.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Archivo cargado:</strong> ${file.name}<br>
                        <strong>Tama√±o:</strong> ${(file.size / 1024).toFixed(2)} KB<br>
                        <strong>Tipo:</strong> ${file.type || 'Desconocido'}
                    </div>
                `;
            }
        }

        // Procesar archivo subido
        function processUploadedFile() {
            const fileInput = document.getElementById('file-input');
            if (!fileInput.files[0]) {
                alert('Por favor selecciona un archivo primero');
                return;
            }
            
            // Simular procesamiento
            const result = document.getElementById('upload-result');
            result.innerHTML += `
                <div class="alert alert-warning">
                    <strong>‚è≥ Procesando archivo...</strong><br>
                    Extrayendo datos de la factura...
                </div>
            `;
            
            setTimeout(() => {
                // Crear factura simulada del archivo
                const simulatedInvoice = {
                    id: Date.now(),
                    userId: currentUser.id,
                    number: 'UP' + Date.now().toString().slice(-6),
                    date: new Date().toISOString().split('T')[0],
                    clientName: 'Cliente desde archivo',
                    clientNit: '12345678-9',
                    clientAddress: 'Direcci√≥n extra√≠da del archivo',
                    items: [
                        {
                            description: 'Producto desde archivo',
                            quantity: 1,
                            price: 100000,
                            total: 100000
                        }
                    ],
                    subtotal: 100000,
                    iva: 19000,
                    total: 119000,
                    status: 'pendiente',
                    createdAt: new Date().toISOString(),
                    source: 'uploaded'
                };
                
                invoices.push(simulatedInvoice);
                saveData();
                
                result.innerHTML += `
                    <div class="alert alert-success">
                        <strong>‚úÖ Archivo procesado exitosamente</strong><br>
                        Factura creada con n√∫mero: ${simulatedInvoice.number}<br>
                        <strong>Total:</strong> ${simulatedInvoice.total.toLocaleString()}
                    </div>
                `;
                
                // Simular env√≠o a DIAN
                setTimeout(() => {
                    simulateDianSubmission(simulatedInvoice.id);
                }, 3000);
                
            }, 2000);
        }

        // Simular env√≠o a DIAN
        function simulateDianSubmission(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;
            
            // Simular proceso de env√≠o
            const success = Math.random() > 0.2; // 80% de √©xito
            
            if (success) {
                invoice.status = 'enviado';
                invoice.dianCode = 'DIAN' + Date.now().toString().slice(-8);
                invoice.sentAt = new Date().toISOString();
                
                // Mostrar notificaci√≥n de √©xito
                showNotification(`‚úÖ Factura ${invoice.number} enviada exitosamente a la DIAN`, 'success');
            } else {
                invoice.status = 'rechazado';
                invoice.rejectionReason = 'Error en validaci√≥n de datos';
                
                // Mostrar notificaci√≥n de error
                showNotification(`‚ùå Factura ${invoice.number} rechazada por la DIAN`, 'danger');
            }
            
            saveData();
            updateDashboard();
        }

        // Mostrar notificaci√≥n
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.innerHTML = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.maxWidth = '400px';
            notification.style.animation = 'slideInRight 0.5s ease-out';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Actualizar dashboard
        function updateDashboard() {
            if (!currentUser) return;
            
            // Actualizar nombre de la empresa del usuario en el header
            const companyHeader = document.getElementById('company-name-header');
            const currentUserName = document.getElementById('current-user-name');
            const currentDate = document.getElementById('current-date');
            
            if (companyHeader) {
                companyHeader.textContent = currentUser.company;
            }
            
            if (currentUserName) {
                currentUserName.textContent = currentUser.username;
            }
            
            if (currentDate) {
                const now = new Date();
                const dateOptions = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                currentDate.textContent = now.toLocaleDateString('es-CO', dateOptions);
            }
            
            const userInvoices = invoices.filter(inv => inv.userId === currentUser.id);
            const totalFacturas = userInvoices.length;
            const enviadasDian = userInvoices.filter(inv => inv.status === 'enviado').length;
            const pendientes = userInvoices.filter(inv => inv.status === 'pendiente').length;
            const totalFacturado = userInvoices.reduce((sum, inv) => sum + inv.total, 0);
            
            document.getElementById('total-facturas').textContent = totalFacturas;
            document.getElementById('enviadas-dian').textContent = enviadasDian;
            document.getElementById('pendientes').textContent = pendientes;
            document.getElementById('total-facturado').textContent = totalFacturado.toLocaleString();
        }

        // Cargar lista de facturas
        function loadInvoiceList() {
            if (!currentUser) return;
            
            const userInvoices = invoices.filter(inv => inv.userId === currentUser.id);
            const listContainer = document.getElementById('invoice-list');
            
            if (userInvoices.length === 0) {
                listContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>üìã No hay facturas creadas</strong><br>
                        Comienza creando tu primera factura desde el men√∫ principal.
                    </div>
                `;
                return;
            }
            
            listContainer.innerHTML = userInvoices.map(invoice => `
                <div class="invoice-item" data-invoice-id="${invoice.id}">
                    <div>
                        <h4 style="margin: 0; color: #2c3e50;">Factura ${invoice.number}</h4>
                        <p style="margin: 5px 0; color: #666;">
                            <strong>Cliente:</strong> ${invoice.clientName}<br>
                            <strong>Fecha:</strong> ${new Date(invoice.date).toLocaleDateString()}<br>
                            <strong>Total:</strong> ${invoice.total.toLocaleString()}
                        </p>
                        ${invoice.dianCode ? `<p style="margin: 5px 0; color: #28a745;"><strong>C√≥digo DIAN:</strong> ${invoice.dianCode}</p>` : ''}
                        ${invoice.rejectionReason ? `<p style="margin: 5px 0; color: #dc3545;"><strong>Motivo rechazo:</strong> ${invoice.rejectionReason}</p>` : ''}
                    </div>
                    <div style="text-align: right;">
                        <div class="status ${invoice.status}" style="margin-bottom: 10px;">
                            ${invoice.status === 'enviado' ? '‚úÖ Enviado' : 
                              invoice.status === 'rechazado' ? '‚ùå Rechazado' : '‚è≥ Pendiente'}
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="printInvoice(${invoice.id})" style="margin: 2px;">üñ®Ô∏è Imprimir</button>
                            ${invoice.status === 'pendiente' ? `<button class="btn btn-success" onclick="sendToDian(${invoice.id})" style="margin: 2px;">üì§ Enviar</button>` : ''}
                            ${invoice.status === 'rechazado' ? `<button class="btn btn-warning" onclick="resendToDian(${invoice.id})" style="margin: 2px;">üîÑ Reenviar</button>` : ''}
                            <button class="btn btn-danger" onclick="deleteInvoice(${invoice.id})" style="margin: 2px;">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Filtrar facturas
        function filterInvoices() {
            const searchTerm = document.getElementById('search-invoice').value.toLowerCase();
            const invoiceItems = document.querySelectorAll('.invoice-item');
            
            invoiceItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Imprimir factura
        function printInvoice(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;
            
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Factura ${invoice.number}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        .company-info { margin-bottom: 30px; }
                        .client-info { margin-bottom: 30px; }
                        .items-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        .items-table th, .items-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        .items-table th { background-color: #f2f2f2; }
                        .totals { text-align: right; }
                        .footer { margin-top: 50px; text-align: center; font-size: 12px; color: #666; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>FACTURA ELECTR√ìNICA</h1>
                        <h2>${currentUser.company}</h2>
                        <p>NIT: ${currentUser.nit}</p>
                    </div>
                    
                    <div class="company-info">
                        <h3>DATOS DE FACTURACI√ìN</h3>
                        <p><strong>N√∫mero de Factura:</strong> ${invoice.number}</p>
                        <p><strong>Fecha:</strong> ${new Date(invoice.date).toLocaleDateString()}</p>
                        ${invoice.dianCode ? `<p><strong>C√≥digo DIAN:</strong> ${invoice.dianCode}</p>` : ''}
                    </div>
                    
                    <div class="client-info">
                        <h3>FACTURAR A:</h3>
                        <p><strong>Cliente:</strong> ${invoice.clientName}</p>
                        <p><strong>NIT/CC:</strong> ${invoice.clientNit}</p>
                        <p><strong>Direcci√≥n:</strong> ${invoice.clientAddress}</p>
                    </div>
                    
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Descripci√≥n</th>
                                <th>Cantidad</th>
                                <th>Valor Unitario</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.items.map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.price.toLocaleString()}</td>
                                    <td>${item.total.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="totals">
                        <p><strong>Subtotal:</strong> ${invoice.subtotal.toLocaleString()}</p>
                        <p><strong>IVA (19%):</strong> ${invoice.iva.toLocaleString()}</p>
                        <h3><strong>TOTAL:</strong> ${invoice.total.toLocaleString()}</h3>
                    </div>
                    
                    <div class="footer">
                        <p>Factura generada electr√≥nicamente - Sistema FACTURAS</p>
                        <p>DESARROLLO DE SOFTWARE SAS - NIT: 901234567-8</p>
                        <p>Fecha de generaci√≥n: ${new Date().toLocaleString()}</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // Enviar factura individual a DIAN
        function sendToDian(invoiceId) {
            showNotification('üì§ Enviando factura a la DIAN...', 'warning');
            setTimeout(() => {
                simulateDianSubmission(invoiceId);
                loadInvoiceList(); // Recargar lista
            }, 2000);
        }

        // Reenviar factura rechazada
        function resendToDian(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (invoice) {
                invoice.status = 'pendiente';
                invoice.rejectionReason = null;
                saveData();
                sendToDian(invoiceId);
            }
        }

        // Eliminar factura
        function deleteInvoice(invoiceId) {
            if (confirm('¬øEst√°s seguro de que deseas eliminar esta factura?')) {
                const index = invoices.findIndex(inv => inv.id === invoiceId);
                if (index > -1) {
                    invoices.splice(index, 1);
                    saveData();
                    loadInvoiceList();
                    updateDashboard();
                    showNotification('üóëÔ∏è Factura eliminada exitosamente', 'success');
                }
            }
        }

        // Enviar todas las facturas pendientes a DIAN
        function sendAllToDian() {
            if (!currentUser) return;
            
            const pendingInvoices = invoices.filter(inv => 
                inv.userId === currentUser.id && inv.status === 'pendiente'
            );
            
            if (pendingInvoices.length === 0) {
                alert('No hay facturas pendientes para enviar');
                return;
            }
            
            if (confirm(`¬øDeseas enviar ${pendingInvoices.length} factura(s) pendiente(s) a la DIAN?`)) {
                showNotification(`üì§ Enviando ${pendingInvoices.length} facturas a la DIAN...`, 'warning');
                
                pendingInvoices.forEach((invoice, index) => {
                    setTimeout(() => {
                        simulateDianSubmission(invoice.id);
                        
                        // Si es la √∫ltima factura, actualizar dashboard
                        if (index === pendingInvoices.length - 1) {
                            setTimeout(() => {
                                updateDashboard();
                            }, 1000);
                        }
                    }, (index + 1) * 1000);
                });
            }
        }

        // Probar conexi√≥n con DIAN
        function testDianConnection() {
            showNotification('üîÑ Probando conexi√≥n con la DIAN...', 'warning');
            
            setTimeout(() => {
                const success = Math.random() > 0.1; // 90% de √©xito
                
                if (success) {
                    showNotification('‚úÖ Conexi√≥n con la DIAN exitosa', 'success');
                } else {
                    showNotification('‚ùå Error de conexi√≥n con la DIAN. Intenta m√°s tarde.', 'danger');
                }
            }, 2000);
        }

        // Inicializar aplicaci√≥n
        function initApp() {
            console.log('Inicializando aplicaci√≥n...');
            loadData();
            
            // Adjuntar listeners a los campos de productos existentes
            const existingRows = document.querySelectorAll('.item-row');
            existingRows.forEach(attachItemListeners);
            
            // Mostrar pantalla de login
            showScreen('login');
            
            console.log('Total de usuarios cargados:', users.length);
            console.log('Usuario administrador disponible:', users.find(u => u.username === 'admin'));
            console.log('Base de datos de usuarios:', userDatabase.map(u => ({ usuario: u.username, empresa: u.company })));
        }

        // CSS para animaciones adicionales
        const additionalCSS = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            .btn:active {
                transform: translateY(1px);
            }
            
            .card {
                transition: all 0.3s ease;
            }
            
            .invoice-item:hover {
                background-color: #f8f9fa;
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = additionalCSS;
        document.head.appendChild(styleSheet);

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>